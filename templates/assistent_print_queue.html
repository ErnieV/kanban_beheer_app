{% extends "base.html" %}
{% block content %}
<div class="mb-4">
    <a href="{{ url_for('dashboard') }}" class="text-decoration-none text-muted">
        <i class="bi bi-arrow-left"></i> Terug naar Dashboard
    </a>
</div>

<div class="d-flex justify-content-between align-items-center mb-3">
    <h2><i class="bi bi-printer"></i> Print Wachtrij</h2>
    <span class="badge bg-primary">{{ queue_items|length }} aanvragen</span>
</div>

<div class="card shadow-sm">
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-bordered table-striped table-hover align-middle mb-0" style="font-size: 0.9rem;">
                <thead class="table-light">
                    <tr>
                        <th style="width: 15%;">Header Info</th>
                        <th style="width: 20%;">Artikel Details</th>
                        <th style="width: 15%;">Logistiek</th>
                        <th style="width: 25%;">QR & Codes</th>
                        <th style="width: 10%;">Status</th>
                        <th style="width: 100px;" class="text-end">Acties</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in queue_items %}
                    <tr>
                        <!-- HEADER INFO -->
                        <td>
                            <div class="d-flex align-items-center mb-1">
                                <span class="border rounded me-2 shadow-sm" style="width: 24px; height: 24px; background-color: {{ item.header_color|default('#ccc') }};"></span>
                                <span class="text-monospace small">{{ item.header_color }}</span>
                            </div>
                            <div class="fw-bold text-uppercase small">{{ item.header_text }}</div>
                        </td>

                        <!-- ARTIKEL -->
                        <td>
                            <strong>{{ item.product_name }}</strong><br>
                            <span class="text-muted">{{ item.product_packaging }}</span><br>
                            <small class="text-dark">SKU: <span class="font-monospace">{{ item.product_sku }}</span></small>
                            <br>
                            {% if item.product_image_url %}
                                <a href="{{ item.product_image_url }}" target="_blank" class="small text-decoration-none text-success">
                                    <i class="bi bi-image"></i> Foto aanwezig
                                </a>
                            {% else %}
                                <span class="small text-muted text-decoration-line-through"><i class="bi bi-image"></i> Geen foto</span>
                            {% endif %}
                        </td>

                        <!-- LOGISTIEK -->
                        <td>
                            <div>{{ item.location_text }}</div>
                            <div class="mt-1">
                                <span class="badge bg-light text-dark border me-1">Min: {{ item.min_level }}</span>
                                <span class="badge bg-light text-dark border">Max: {{ item.max_level }}</span>
                            </div>
                        </td>

                        <!-- CODES -->
                        <td>
                            <div class="font-monospace small text-break bg-light p-1 rounded mb-1" style="font-size: 0.75rem;">
                                {{ item.qr_code_value }}
                            </div>
                            <small class="text-muted">Tekst: <strong>{{ item.qr_human_readable }}</strong></small>
                        </td>

                        <!-- STATUS -->
                        <td>
                            <div class="small text-muted mb-1">{{ item.aangemaakt_op.strftime('%d-%m %H:%M') }}</div>
                            {% if item.status == 'PENDING' %}
                                <span class="badge bg-warning text-dark w-100"><i class="bi bi-hourglass-split"></i> Wacht</span>
                            {% else %}
                                <span class="badge bg-secondary w-100">{{ item.status }}</span>
                            {% endif %}
                        </td>

                        <!-- ACTIES -->
                        <td class="text-end">
                            <div class="btn-group-vertical btn-group-sm">
                                <!-- DETAILS KNOP (Voorbeeld) -->
                                <button type="button" class="btn btn-outline-info mb-1" 
                                        title="Bekijk voorbeeld"
                                        onclick="showDetails(this)"
                                        data-id="{{ item.print_id }}"
                                        data-header="{{ item.header_text }}"
                                        data-color="{{ item.header_color }}"
                                        data-product="{{ item.product_name }}"
                                        data-packaging="{{ item.product_packaging }}"
                                        data-sku="{{ item.product_sku }}"
                                        data-img="{{ item.product_image_url }}"
                                        data-location="{{ item.location_text }}"
                                        data-min="{{ item.min_level }}"
                                        data-max="{{ item.max_level }}"
                                        data-qr="{{ item.qr_code_value }}"
                                        data-human="{{ item.qr_human_readable }}">
                                    <i class="bi bi-eye"></i> Voorbeeld
                                </button>

                                <!-- DIRECT VERWIJDEREN KNOP -->
                                <form action="{{ url_for('annuleren_print_opdracht', print_id=item.print_id) }}" method="POST" onsubmit="return confirm('Aanvraag direct verwijderen uit wachtrij?');">
                                    <button type="submit" class="btn btn-outline-danger w-100" title="Verwijder uit wachtrij">
                                        <i class="bi bi-trash"></i> Verwijder
                                    </button>
                                </form>
                            </div>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="6" class="text-center py-5 text-muted">
                            <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                            De printwachtrij is leeg.
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- DETAILS MODAL (PREVIEW) -->
<div class="modal fade" id="detailsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Voorbeeld Kaartje</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body d-flex justify-content-center bg-light">
                <!-- PREVIEW VAN HET KAARTJE -->
                <div class="card shadow-sm bg-white" style="width: 280px; border: 1px solid #999;">
                    <!-- Header Simulatie -->
                    <div id="modalHeader" class="text-white fw-bold text-center py-2 text-uppercase" style="background-color: #333; font-size: 1.1rem;">
                        HEADER TEXT
                    </div>
                    <div class="card-body text-center p-3">
                        <h5 class="card-title fw-bold mb-0" id="modalProduct" style="font-size: 1.25rem;">Product Naam</h5>
                        <p class="text-muted mb-2" id="modalPackaging" style="font-size: 0.9rem;">Verpakking</p>
                        
                        <!-- Placeholder voor plaatje -->
                        <div class="d-flex align-items-center justify-content-center mx-auto mb-2" style="width: 120px; height: 120px;">
                            <img id="modalImg" src="" alt="Artikel" style="max-width: 100%; max-height: 100%; display: none;">
                            <i id="modalNoImg" class="bi bi-box-seam text-secondary" style="font-size: 4rem; opacity: 0.3;"></i>
                        </div>

                        <!-- Logistics Bar -->
                        <div class="row g-0 border-top border-bottom py-1 mb-2 bg-light" style="font-size: 0.85rem;">
                            <div class="col-4 border-end"><strong>MIN</strong><br><span id="modalMin" class="fs-6">1</span></div>
                            <div class="col-4 border-end"><strong>MAX</strong><br><span id="modalMax" class="fs-6">5</span></div>
                            <div class="col-4"><div class="text-truncate px-1 pt-2 fw-bold" id="modalLocation">KAST</div></div>
                        </div>

                        <!-- QR Simulatie -->
                        <div class="mb-1">
                            <i class="bi bi-qr-code-scan" style="font-size: 3rem;"></i>
                        </div>
                        <div class="font-monospace fw-bold" id="modalHuman" style="font-size: 0.9rem;">CODE</div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Sluiten</button>
            </div>
        </div>
    </div>
</div>

<script>
    function showDetails(button) {
        // Haal data op uit attributen
        const d = button.dataset;

        // Vul Visuele Preview
        const headerEl = document.getElementById('modalHeader');
        headerEl.textContent = d.header;
        headerEl.style.backgroundColor = d.color || '#333';

        document.getElementById('modalProduct').textContent = d.product;
        document.getElementById('modalPackaging').textContent = d.packaging;
        document.getElementById('modalLocation').textContent = d.location;
        document.getElementById('modalMin').textContent = d.min;
        document.getElementById('modalMax').textContent = d.max;
        document.getElementById('modalHuman').textContent = d.human;

        // Afbeelding handling
        const imgEl = document.getElementById('modalImg');
        const noImgEl = document.getElementById('modalNoImg');
        
        // Simpele check of URL geldig lijkt
        if (d.img && d.img !== 'None' && d.img.length > 5) {
            imgEl.src = d.img;
            imgEl.style.display = 'inline-block';
            noImgEl.style.display = 'none';
        } else {
            imgEl.style.display = 'none';
            noImgEl.style.display = 'inline-block';
        }

        // Toon Modal
        var myModal = new bootstrap.Modal(document.getElementById('detailsModal'));
        myModal.show();
    }
</script>
{% endblock %}