{% extends "base.html" %}
{% block content %}
<div class="mb-4">
    <a href="{{ url_for('dashboard') }}" class="text-decoration-none text-muted">
        <i class="bi bi-arrow-left"></i> Terug naar Dashboard
    </a>
</div>

<div class="d-flex justify-content-between align-items-center mb-3">
    <h2><i class="bi bi-printer"></i> Print Wachtrij</h2>
    <span class="badge bg-primary">{{ queue_items|length }} aanvragen</span>
</div>

<div class="card shadow-sm">
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-bordered table-striped table-hover align-middle mb-0" style="font-size: 0.9rem;">
                <thead class="table-light">
                    <tr>
                        <th style="width: 20%;">Locatie & Header</th>
                        <th style="width: 25%;">Artikel</th>
                        <th style="width: 10%;">Logistiek</th>
                        <th style="width: 15%;" class="text-center">QR Code</th>
                        <th style="width: 10%;">Status</th>
                        <th style="width: 100px;" class="text-end">Acties</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in queue_items %}
                    <tr>
                        <!-- HEADER INFO & LOGO -->
                        <td>
                            <!-- Header Preview -->
                            <div class="p-2 mb-2 text-center text-white fw-bold text-uppercase rounded shadow-sm" 
                                 style="background-color: {{ item.header_color|default('#333') }}; font-size: 0.85rem;">
                                {{ item.header_text }}
                            </div>
                            
                            <!-- Bedrijfslogo -->
                            {% if item.company_logo_url %}
                                <div class="text-center">
                                    <img src="{{ item.company_logo_url }}" alt="Logo" style="max-height: 25px; opacity: 0.8;">
                                </div>
                            {% endif %}
                            <div class="text-muted small text-center mt-1">{{ item.location_text }}</div>
                        </td>

                        <!-- ARTIKEL -->
                        <td>
                            <div class="d-flex">
                                <!-- Product Foto -->
                                <div class="me-3 flex-shrink-0">
                                    {% if item.product_image_url %}
                                        <img src="{{ item.product_image_url }}" class="rounded border bg-white" style="width: 50px; height: 50px; object-fit: contain;">
                                    {% else %}
                                        <div class="rounded border bg-light d-flex align-items-center justify-content-center text-muted" style="width: 50px; height: 50px;">
                                            <i class="bi bi-box-seam"></i>
                                        </div>
                                    {% endif %}
                                </div>
                                <div>
                                    <strong>{{ item.product_name }}</strong><br>
                                    <span class="text-muted">{{ item.product_packaging }}</span><br>
                                    <small class="text-dark font-monospace">{{ item.product_sku }}</small>
                                </div>
                            </div>
                        </td>

                        <!-- LOGISTIEK -->
                        <td>
                            <div class="d-flex flex-column gap-1">
                                <span class="badge bg-light text-dark border">Min: {{ item.min_level }}</span>
                                <span class="badge bg-light text-dark border">Max: {{ item.max_level }}</span>
                            </div>
                        </td>

                        <!-- QR CODE PREVIEW -->
                        <td class="text-center bg-white">
                            {% if item.qr_code_value and 'http' in item.qr_code_value %}
                                <img src="https://api.qrserver.com/v1/create-qr-code/?size=80x80&data={{ item.qr_code_value }}" 
                                     alt="QR" class="img-fluid" style="width: 60px; height: 60px;">
                            {% else %}
                                <i class="bi bi-qr-code text-muted" style="font-size: 2rem;"></i>
                            {% endif %}
                            <div class="font-monospace fw-bold small mt-1" style="font-size: 0.7rem;">{{ item.qr_human_readable }}</div>
                        </td>

                        <!-- STATUS -->
                        <td>
                            <div class="small text-muted mb-1">{{ item.aangemaakt_op.strftime('%d-%m %H:%M') }}</div>
                            {% if item.status == 'PENDING' %}
                                <span class="badge bg-warning text-dark w-100"><i class="bi bi-hourglass-split"></i> Wacht</span>
                            {% else %}
                                <span class="badge bg-secondary w-100">{{ item.status }}</span>
                            {% endif %}
                        </td>

                        <!-- ACTIES -->
                        <td class="text-end">
                            <div class="btn-group-vertical btn-group-sm w-100">
                                <!-- DETAILS KNOP (Voorbeeld) -->
                                <button type="button" class="btn btn-outline-info mb-1" 
                                        title="Bekijk voorbeeld"
                                        onclick="showDetails(this)"
                                        data-id="{{ item.print_id }}"
                                        data-header="{{ item.header_text }}"
                                        data-color="{{ item.header_color }}"
                                        data-product="{{ item.product_name }}"
                                        data-packaging="{{ item.product_packaging }}"
                                        data-sku="{{ item.product_sku }}"
                                        data-img="{{ item.product_image_url }}"
                                        data-location="{{ item.location_text }}"
                                        data-min="{{ item.min_level }}"
                                        data-max="{{ item.max_level }}"
                                        data-qr="{{ item.qr_code_value }}"
                                        data-human="{{ item.qr_human_readable }}">
                                    <i class="bi bi-eye"></i> Voorbeeld
                                </button>

                                <!-- DIRECT VERWIJDEREN KNOP -->
                                <form action="{{ url_for('annuleren_print_opdracht', print_id=item.print_id) }}" method="POST" onsubmit="return confirm('Aanvraag direct verwijderen uit wachtrij?');">
                                    <button type="submit" class="btn btn-outline-danger w-100" title="Verwijder uit wachtrij">
                                        <i class="bi bi-trash"></i> Verwijder
                                    </button>
                                </form>
                            </div>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="6" class="text-center py-5 text-muted">
                            <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                            De printwachtrij is leeg.
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- DETAILS MODAL (PREVIEW) -->
<div class="modal fade" id="detailsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Voorbeeld Kaartje</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body d-flex justify-content-center bg-light">
                <!-- PREVIEW VAN HET KAARTJE (Badgy Formaat) -->
                <div class="card shadow-sm bg-white position-relative" style="width: 250px; height: 390px; border: 1px solid #999;">
                    <!-- Header -->
                    <div id="modalHeader" class="text-white fw-bold text-center py-3 text-uppercase align-middle d-flex align-items-center justify-content-center" 
                         style="background-color: #333; font-size: 1.1rem; height: 60px;">
                        HEADER
                    </div>
                    
                    <div class="card-body text-center p-3 d-flex flex-column h-100">
                        <!-- Product -->
                        <div class="mb-2">
                            <h5 class="card-title fw-bold mb-0 text-truncate" id="modalProduct" style="font-size: 1.2rem;">Product</h5>
                            <small class="text-muted" id="modalPackaging">Verpakking</small>
                        </div>
                        
                        <!-- Plaatje -->
                        <div class="flex-grow-1 d-flex align-items-center justify-content-center mb-2" style="max-height: 120px;">
                            <img id="modalImg" src="" alt="Artikel" style="max-width: 100%; max-height: 100px; display: none;">
                            <i id="modalNoImg" class="bi bi-box-seam text-secondary" style="font-size: 3rem; opacity: 0.2;"></i>
                        </div>

                        <!-- Info Bar -->
                        <div class="row g-0 border-top border-bottom py-1 mb-3 bg-light text-dark" style="font-size: 0.8rem;">
                            <div class="col-4 border-end pt-1">
                                <div class="fw-bold">MIN</div>
                                <div id="modalMin" class="fs-5">1</div>
                            </div>
                            <div class="col-4 border-end pt-1">
                                <div class="fw-bold">MAX</div>
                                <div id="modalMax" class="fs-5">5</div>
                            </div>
                            <div class="col-4 d-flex align-items-center justify-content-center px-1">
                                <div id="modalLocation" class="fw-bold text-break" style="line-height: 1.1;">LOC</div>
                            </div>
                        </div>

                        <!-- QR Footer -->
                        <div class="mt-auto">
                            <img id="modalQrImg" src="" alt="QR" style="width: 60px; height: 60px;">
                            <div class="font-monospace fw-bold mt-1" id="modalHuman" style="font-size: 0.8rem;">CODE</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Sluiten</button>
            </div>
        </div>
    </div>
</div>

<script>
    function showDetails(button) {
        // Haal data op uit attributen
        const d = button.dataset;

        // Vul Header
        const headerEl = document.getElementById('modalHeader');
        headerEl.textContent = d.header;
        headerEl.style.backgroundColor = d.color || '#333';

        // Vul Product Data
        document.getElementById('modalProduct').textContent = d.product;
        document.getElementById('modalPackaging').textContent = d.packaging;
        document.getElementById('modalLocation').textContent = d.location.split('(')[0]; // Alleen kastnaam
        document.getElementById('modalMin').textContent = d.min;
        document.getElementById('modalMax').textContent = d.max;
        document.getElementById('modalHuman').textContent = d.human;

        // Afbeelding handling
        const imgEl = document.getElementById('modalImg');
        const noImgEl = document.getElementById('modalNoImg');
        
        if (d.img && d.img !== 'None' && d.img.length > 5) {
            imgEl.src = d.img;
            imgEl.style.display = 'inline-block';
            noImgEl.style.display = 'none';
        } else {
            imgEl.style.display = 'none';
            noImgEl.style.display = 'inline-block';
        }

        // QR Code Generatie voor Modal
        const qrEl = document.getElementById('modalQrImg');
        if (d.qr && d.qr.includes('http')) {
             qrEl.src = "https://api.qrserver.com/v1/create-qr-code/?size=100x100&data=" + encodeURIComponent(d.qr);
             qrEl.style.display = 'inline-block';
        } else {
             qrEl.style.display = 'none';
        }

        // Toon Modal
        var myModal = new bootstrap.Modal(document.getElementById('detailsModal'));
        myModal.show();
    }
</script>
{% endblock %}