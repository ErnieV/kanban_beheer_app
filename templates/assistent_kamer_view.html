{% extends "base.html" %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <a href="{{ url_for('assistent_kamers') }}" class="text-decoration-none text-muted mb-1 d-block">
            <i class="bi bi-arrow-left"></i> Terug naar overzicht
        </a>
        <h2>
            <i class="bi bi-door-open-fill" style="color: {{ ruimte.kleur_hex if ruimte.kleur_hex else '#333' }};"></i> 
            {% if ruimte.nummer %}{{ ruimte.nummer }} - {% endif %}{{ ruimte.naam }}
        </h2>
    </div>
    <span class="badge bg-primary fs-6">{{ kasten_data|length }} Opslaglocaties</span>
</div>

<div class="accordion" id="kastenAccordion">
    {% for kast, inhoud in kasten_data.items() %}
    <div class="accordion-item mb-3 shadow-sm border">
        <h2 class="accordion-header" id="heading{{ kast.kast_id }}">
            <div class="d-flex justify-content-between align-items-center bg-white px-3 py-2 border-bottom">
                <button class="accordion-button {% if not loop.first %}collapsed{% endif %} fw-bold shadow-none border-0 p-0" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ kast.kast_id }}">
                    <i class="bi bi-box-seam me-2"></i> {{ kast.naam }} 
                    <span class="text-muted fw-normal ms-2 small">({{ kast.type_opslag }})</span>
                </button>
                
                <!-- BATCH PRINT KNOP -->
                <form action="{{ url_for('kanban_aanvragen_kast', kast_id=kast.kast_id) }}" method="POST" class="ms-3" onsubmit="return confirm('Wil je kaartjes aanvragen voor ALLE artikelen in deze kast?');">
    <input type="hidden" name="_csrf_token" value="{{ csrf_token() }}">
                    <button type="submit" class="btn btn-sm btn-outline-dark" title="Print alle kaartjes voor deze kast">
                        <i class="bi bi-printer-fill"></i> <span class="d-none d-md-inline">Alles Printen</span>
                    </button>
                </form>
            </div>
        </h2>
        <div id="collapse{{ kast.kast_id }}" class="accordion-collapse collapse {% if loop.first %}show{% endif %}" data-bs-parent="#kastenAccordion">
            <div class="accordion-body bg-light-subtle">
                
                <div class="table-responsive bg-white rounded shadow-sm mb-3">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="table-light">
                            <tr>
                                <th style="width:50px;">Foto</th>
                                <th>Artikel</th>
                                <th style="width:100px;">Min</th>
                                <th style="width:100px;">Max</th>
                                <th style="width:80px;" class="text-center">Acties</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for pos, lokaal, globaal in inhoud %}
                            <tr>
                                <td>
                                    {% set img = pos.locatie_foto_url or lokaal.foto_url or (globaal and globaal.foto_url) %}
                                    {% if img %}
                                        <img src="{{ img }}" height="40" class="rounded border" style="object-fit: cover; width: 40px;">
                                    {% else %}
                                        <div class="bg-secondary text-white rounded d-flex justify-content-center align-items-center" style="width:40px; height:40px;">?</div>
                                    {% endif %}
                                </td>
                                <td>
                                    <strong>{{ lokaal.eigen_naam }}</strong>
                                    {% if globaal %}
                                        <i class="bi bi-globe text-primary small" title="Global"></i>
                                    {% else %}
                                        <i class="bi bi-hdd-network text-warning small" title="Lokaal"></i>
                                    {% endif %}
                                    <br>
                                    <small class="text-muted">{{ lokaal.verpakkingseenheid_tekst }}</small>
                                </td>
                                
                                <form action="{{ url_for('update_voorraad_positie', voorraad_positie_id=pos.voorraad_positie_id) }}" method="POST">
    <input type="hidden" name="_csrf_token" value="{{ csrf_token() }}">
                                    <td>
                                        <input type="number" name="trigger_min" value="{{ pos.trigger_min }}" class="form-control form-control-sm" onchange="this.form.submit()">
                                    </td>
                                    <td>
                                        <input type="number" name="target_max" value="{{ pos.target_max }}" class="form-control form-control-sm" onchange="this.form.submit()">
                                    </td>
                                    <td class="text-center">
                                        <div class="btn-group">
                                            <!-- ENKEL PRINT KNOP -->
                                            <button type="submit" formaction="{{ url_for('kanban_aanvragen_enkel', voorraad_positie_id=pos.voorraad_positie_id) }}" class="btn btn-sm btn-outline-secondary" title="Kaartje aanvragen">
                                                <i class="bi bi-printer"></i>
                                            </button>
                                            
                                            <!-- VERWIJDER KNOP -->
                                            <button type="submit" formaction="{{ url_for('verwijder_item', type='voorraad', id=pos.voorraad_positie_id) }}" class="btn btn-sm btn-outline-danger" onclick="return confirm('Verwijderen?')">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </form>
                            </tr>
                            {% else %}
                            <tr><td colspan="5" class="text-center text-muted py-3">Deze kast is nog leeg.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <form action="{{ url_for('add_to_kast_from_room', kast_id=kast.kast_id) }}" method="POST" class="row g-2 align-items-center">
    <input type="hidden" name="_csrf_token" value="{{ csrf_token() }}">
                    <div class="col-auto">
                        <span class="form-text fw-bold">Artikel toevoegen:</span>
                    </div>
                    <div class="col-md-4">
                        <select name="artikel_id" class="form-select form-select-sm" required>
                            <option value="" selected disabled>Kies artikel...</option>
                            {% for art in alle_artikelen %}
                                <option value="{{ art.lokaal_artikel_id }}">
                                    {{ art.eigen_naam }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-auto">
                        <button type="submit" class="btn btn-sm btn-success"><i class="bi bi-plus"></i></button>
                    </div>
                </form>

            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% endblock %}